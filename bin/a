#!/usr/bin/env ruby

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename(__FILE__)} [-V] COMMAND DIR"

  opts.on('-V', '--verbose', 'Print more info') { |v| options[:verbose] = v }
end.parse!

VERBOSE = options[:verbose]

EXAMPLE_STR = %[example:
a gem mytest
will create new gem project named mytest directory.]

DIR_ERROR_STR = %[Must have a target dir
for example: a gem mytest]

TARGET_ERROR_STR = "Here is a list of target you can use:\n"

#ex: gem
def target
  unless ARGV.first
    puts(EXAMPLE_STR)
    exit(1)
  end
  ARGV.first.capitalize
end

#ex: mytest
def dir
  dir = ARGV.last
  unless dir
    puts(DIR_ERROR_STR)
    exit(2)
  end
  dir
end

def list_targets(targets_path)
  entries = Dir.entries(targets_path).keep_if { |e| e.include?('.rb') }
  entries.map! { |e| File.basename(e, '.rb') }
end

def main
  begin 
    require_relative File.join('../lib/commands', target.downcase)
  rescue LoadError
    puts(%[The target "#{target}" does not exist!\n] + TARGET_ERROR_STR)
    list_targets('lib/commands').each { |e| puts(e) }
    exit(4)
  end
  A::Gem.new(dir: dir, target: target, verbose: VERBOSE)
end

main
